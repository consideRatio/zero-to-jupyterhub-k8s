{{- /*
Returns a placeholder pod specification.
*/}}
{{- define "jupyterhub.placeholder.pod-spec" -}}
priorityClassName: placeholder-priority
tolerations:
  {{- /*
  The '/' had to be escaped to '_' to support GKE...
  See: https://issuetracker.google.com/issues/77240642
  */}}
  - key: hub.jupyter.org_dedicated
    operator: Equal
    value: user
    effect: NoSchedule
affinity:
  nodeAffinity:
    {{- if .perNode }}
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: hub.jupyter.org/purpose
              operator: In
              values:
                - user
    {{- else }}
    preferredDuringSchedulingIgnoredDuringExecution:
      - preference:
          matchExpressions:
            - key: hub.jupyter.org/purpose
              operator: In
              values:
                - user
        weight: 10
    {{- end }}
terminationGracePeriodSeconds: 0
automountServiceAccountToken: false
containers:
  - name: pause
    image: {{ .Values.prePuller.pause.image.name }}:{{ .Values.prePuller.pause.image.tag }}
    resources:
      {{- if .perNode }}
      {{- include "jupyterhub.placeholder.resources.per-node" . | nindent 6 }}
      {{- else }}
      {{- include "jupyterhub.placeholder.resources.fixed" . | nindent 6 }}
      {{- end }}
{{- end }}


{{- /*
The default resource request - whatever a singleuser requests.
*/}}
{{- define "jupyterhub.placeholder.resources.default" }}
requests:
  cpu: {{ .Values.singleuser.cpu.guarantee }}
  memory: {{ .Values.singleuser.memory.guarantee }}
limits:
  cpu: {{ .Values.singleuser.cpu.limit }}
  memory: {{ .Values.singleuser.memory.limit }}
{{- end }}


{{- /*
A custom resource request for the one placeholder per node.
*/}}
{{- define "jupyterhub.placeholder.resources.per-node" }}
{{- if .Values.placeholder.perNode.resources }}
{{- .Values.placeholder.perNode.resources | toYaml | trimSuffix "\n" | nindent 0 }}
{{- else }}
{{- include "jupyterhub.placeholder.resources.default" . | nindent 0 }}
{{- end }}
{{- end }}


{{- /*
A custom resource request for the fixed amount of placeholders.
*/}}
{{- define "jupyterhub.placeholder.resources.fixed" }}
{{- if .Values.placeholder.fixed.resources }}
{{- .Values.placeholder.fixed.resources | toYaml | trimSuffix "\n" | nindent 0 }}
{{- else }}
{{- include "jupyterhub.placeholder.resources.default" . | nindent 0 }}
{{- end }}
{{- end }}
