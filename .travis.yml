os: linux
dist: bionic
language: python
python:
  - 3.7
git:
  ## depth set to false overrides travis default behavior to use shallow clones
  ## with depth 50 that can cause issues
  ##
  ## ref: https://github.com/jupyterhub/chartpress#shallow-clones
  ##
  depth: false
services:
  - docker

stages:
  - name: publish
    if: tag IS present OR ( branch IN (master) AND type IN (push) )
  - name: test

before_install:
  # Exit immediately if a command exits with a non-zero status.
  - set -e
  - . ci/common
  # NOTE: The latest docker python package (4.3.0) requires a more modern docker
  #       version (newer than 18.06.0-ce / API version: 1.38) which is not yet
  #       available on travis.
  - pip install "docker~=4.2.0"

# The default install script below will prepare a k8s cluster to work with, but
# not install JupyterHub itself, as upgrade tests may want to make multiple
# installations in sequence etc.
install:
  # Fix to avoid rebuilding images already built
  - remove_docker_mirror_on_travis

  # Setup our k3s based Kubernetes cluster and use its kubectl as well
  - setup_k3s
  - setup_helm
  - helm repo add jupyterhub https://jupyterhub.github.io/helm-chart/
  - helm repo update

  # Install a local ACME server
  - helm install pebble jupyterhub/pebble --values dev-config-pebble.yaml

  # Build our images if needed and update values.yaml with the tags
  - pip3 install --no-cache-dir -r dev-requirements.txt
  - chartpress

  # Pre-install JupyterHub
  - await_dns     # part of k3s, jupyterhub needs it while referencing https://pebble/dir
  - await_calico  # installed with setup_k3s, enforces netpol
  - await_pebble  # jupyterhub's autohttps communicates with it as the ACME server
script:
  # Install JupyterHub
  - helm install jupyterhub ./jupyterhub --values dev-config.yaml --set proxy.traefik.image.tag=v2.2.11
  - await_jupyterhub
  - await_autohttps_tls_cert_acquisition

  # Run tests
  # DISABLED FOR INTERMITTENCY TESTING OF AUTOHTTPS CERT ACQUISITION
  # - pytest --verbose --exitfirst ./tests || (full_namespace_report && exit 1)

env:
  ## Global environment variables will act as defaults, jobs will override them
  ## k3s versions:  https://github.com/rancher/k3s/releases
  ## helm versions: https://github.com/helm/helm/releases
  global:
    - K3S_VERSION=v1.19.3+k3s1
    - HELM_VERSION=v3.3.4

jobs:
  ## don't wait for the jobs that are allowed to fail to report success
  ##
  ## ref: https://docs.travis-ci.com/user/customizing-the-build/#rows-that-are-allowed-to-fail
  ## ref: https://docs.travis-ci.com/user/customizing-the-build/#fast-finishing
  ##
  allow_failures:
    - name: docs:link-check
  fast_finish: true

  ## define individual jobs that can rely on defaults from above
  include:
    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-01

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-02

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-03

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-04

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-05

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-06

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-07

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-08

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-09

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-10

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-11

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-12

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-13

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-14

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-15

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-16

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-17

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-18

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-19

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-20

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-21

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-22

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-23

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-24

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-25

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-26

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-27

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-28

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-29

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-30

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-31

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-32

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-33

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-34

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-35

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-36

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-37

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-38

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-39

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-40

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-41

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-42

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-43

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-44

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-45

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-46

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-47

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-48

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-49

    ## k3s versions:  https://github.com/rancher/k3s/releases
    - stage: test
      name: intermittency-test-50
